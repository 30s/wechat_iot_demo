function GizwitsWS(i,e,n,t,o){this.onInit=void 0,this.onConnected=void 0,this.onOnlineStatusChanged=void 0,this.onReceivedRaw=void 0,this.onReceivedAttrs=void 0,this.onError=void 0,this._openId=e,this._appId=n,this._commType=t,void 0==o?this._socketType="ssl_socket":this._socketType=o,this._apiHost=i,this._websocket={},this._heartbeatTimerId={},this._wsUrl="{0}/ws/app/v1",this._userId=void 0,this._userToken=void 0,this._bindingDevices=void 0}GizwitsWS.prototype.init=function(){var i=this;i._getUserToken()},GizwitsWS.prototype.connect=function(i){var e=this;if(void 0==e._bindingDevices)return void e._sendError("Please call 'init()' firstly.");var n=e._bindingDevices[i];if(null==n)return void e._sendError("Device is not bound.");n.subscribed=!0;var t=e._getWebsocketConnInfo(n);null==e._websocket[t]?e._connectWS(t):e.onConnected()},GizwitsWS.prototype.send=function(i,e){var n=this;if(void 0==n._bindingDevices)return void n._sendError("Please call 'init()' firstly.");var t=n._bindingDevices[i];if(null==t)return void n._sendError("Device is not bound.");var o=n._getWebsocketConnInfo(t);return n._sendJson(o,{cmd:"c2s_raw",data:{did:i,raw:e}})},GizwitsWS.prototype.read=function(i){var e=this;if(void 0==e._bindingDevices)return void e._sendError("Please call 'init()' firstly.");var n=e._bindingDevices[i];if(null==n)return void e._sendError("Device is not bound.");var t=e._getWebsocketConnInfo(n);return e._sendJson(t,{cmd:"c2s_read",data:{did:i}})},GizwitsWS.prototype.write=function(i,e){var n=this;if(void 0==n._bindingDevices)return void n._sendError("Please call 'init()' firstly.");var t=n._bindingDevices[i];if(null==t)return void n._sendError("Device is not bound.");var o=n._getWebsocketConnInfo(t);return n._sendJson(o,{cmd:"c2s_write",data:{did:i,attrs:e}})},GizwitsWS.prototype._getUserToken=function(){var i=this,e="https://{0}/app/users".format(i._apiHost);$.ajax(e,{type:"POST",contentType:"application/json",headers:{"X-Gizwits-Application-Id":i._appId},dataType:"json",data:'{"phone_id":"'+i._openId+'","lang":"en"}'}).done(function(e){i._userId=e.uid,i._userToken=e.token;var n=20,t=0;i._bindingDevices={},i._getBindingList(n,t)}).fail(function(e){i._sendError("Init error when getting user token.")})},GizwitsWS.prototype._getBindingList=function(i,e){var n=this,t="https://{0}/app/bindings".format(n._apiHost),o="?show_disabled=0&limit="+i+"&skip="+e;$.ajax(t+o,{type:"GET",contentType:"application/json",dataType:"json",headers:{"X-Gizwits-Application-Id":n._appId,"X-Gizwits-User-token":n._userToken}}).done(function(t){for(var o in t.devices){var s=t.devices[o];s.subscribed=!1;var r=s.did;n._bindingDevices[r]=s}t.devices.length==i?n._getBindingList(i,e+i):n._returnDeviceList()}).fail(function(i){n._bindingDevices=void 0,n._sendError("Init error when getting binding devices.")})},GizwitsWS.prototype._connectWS=function(i){var e=this,n=new WebSocket(e._wsUrl.format(i));n.onopen=function(n){e._onWSOpen(n,i)},n.onclose=function(n){e._onWSClose(n,i)},n.onmessage=function(n){e._onWSMessage(n,i)},n.onerror=function(n){e._onWSError(n,i)},e._websocket[i]=n},GizwitsWS.prototype._onWSOpen=function(i,e){var n=this,t={cmd:"login_req",data:{appid:n._appId,uid:n._userId,token:n._userToken,p0_type:n._commType,heartbeat_interval:18e4}};n._sendJson(e,t)},GizwitsWS.prototype._onWSClose=function(i,e){var n=this;n._stopPing(e),n._connectWS(e)},GizwitsWS.prototype._onWSMessage=function(i,e){var n=this,t=JSON.parse(i.data);switch(t.cmd){case"pong":break;case"login_res":1==t.data.success?(n._startPing(e),n.onConnected&&n.onConnected()):n._sendError("Connect error.");break;case"s2c_online_status":var o=n._getBindingDevice(t.data.did);n.onOnlineStatusChanged&&o&&o.subscribed&&n.onOnlineStatusChanged({did:o.did,is_online:t.data.online});break;case"s2c_raw":var o=n._getBindingDevice(t.data.did);n.onReceivedRaw&&o&&o.subscribed&&n.onReceivedRaw({did:o.did,raw:t.data.raw});break;case"s2c_noti":var o=n._getBindingDevice(t.data.did);n.onReceivedAttrs&&o&&o.subscribed&&n.onReceivedAttrs({did:o.did,attrs:t.data.attrs});break;case"s2c_invalid_msg":n._sendError(t.data.msg)}},GizwitsWS.prototype._onWSError=function(i,e){var n=this;n._sendError("Websocket on error")},GizwitsWS.prototype._startPing=function(i){var e=this;e._heartbeatTimerId[i]=window.setInterval(function(){e._sendJson(i,{cmd:"ping"})},6e4)},GizwitsWS.prototype._stopPing=function(i){var e=this;window.clearInterval(e._heartbeatTimerId[i])},GizwitsWS.prototype._sendJson=function(i,e){var n=this,t=JSON.stringify(e);return n._sendData(i,t)},GizwitsWS.prototype._sendData=function(i,e){var n=this,t=n._websocket[i];return t.readyState==t.OPEN?(t.send(e),!0):(console.log("Send data error, websocket is not connected."),!1)},GizwitsWS.prototype._sendError=function(i){this.onError&&this.onError(i)},GizwitsWS.prototype._returnDeviceList=function(){var i=this;if(i.onInit){var e=[],n=0;for(var t in i._bindingDevices)e[n]={did:i._bindingDevices[t].did,mac:i._bindingDevices[t].mac,product_key:i._bindingDevices[t].product_key,is_online:i._bindingDevices[t].is_online,dev_alias:i._bindingDevices[t].dev_alias,remark:i._bindingDevices[t].remark},n++;i.onInit(e)}},GizwitsWS.prototype._getBindingDevice=function(i){var e=this;return e._bindingDevices[i]},GizwitsWS.prototype._getWebsocketConnInfo=function(i){var e=this,n=i.host,t="ws://",o=i.ws_port.toString();return"ssl_socket"==e._socketType&&(t="wss://",o=i.wss_port.toString()),t+n+":"+o},String.prototype.format=function(){var i=arguments;return this.replace(/\{(\d+)\}/g,function(e,n){return i[n]})};